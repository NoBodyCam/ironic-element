#!/bin/bash
set -eux

install -d -m 0750 -o ironic -g ironic /etc/ironic
cp /opt/stack/ironic/etc/ironic/policy.json /etc/ironic
cp -a /opt/stack/ironic/etc/ironic/rootwrap* /etc/ironic

ln -sf /opt/stack/venvs/ironic/bin/ironic-rootwrap /usr/local/bin/ironic-rootwrap

echo "ironic ALL=(root) NOPASSWD: /usr/local/bin/ironic-rootwrap" > /etc/sudoers.d/ironic
chmod 0440 /etc/sudoers.d/ironic
visudo -c

os-svc-daemon ironic-conductor ironic ironic-conductor "--debug --verbose --log-config /etc/ironic/logging-conductor.conf --config-file /etc/ironic/ironic.conf"

os-svc-daemon ironic-api ironic ironic-api "--debug --verbose --log-config /etc/ironic/logging-api.conf --config-file /etc/ironic/ironic.conf"
